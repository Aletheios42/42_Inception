# 42 Inception - WordPress LEMP Stack Dockerizado

## Tabla de Contenidos

1. [Introducci칩n](#introducci칩n)
2. [Arquitectura del Proyecto](#arquitectura-del-proyecto)
3. [Flujo de Ejecuci칩n Completo](#flujo-de-ejecuci칩n-completo)
4. [Configuraci칩n Detallada por Servicio](#configuraci칩n-detallada-por-servicio)
5. [Redes y Vol칰menes](#redes-y-vol칰menes)
6. [Gesti칩n de Secretos](#gesti칩n-de-secretos)
7. [Comandos y Debugging](#comandos-y-debugging)
8. [Troubleshooting](#troubleshooting)

---

## Introducci칩n

**Inception** es un proyecto de 42 School que consiste en dockerizar un stack LEMP (Linux, Nginx, MariaDB, PHP) con WordPress. El objetivo es crear una infraestructura containerizada completamente funcional usando **Docker Compose**.

### Requisitos del Proyecto
- **Nginx**: Solo tr치fico HTTPS (puerto 443) con certificados TLS
- **WordPress + PHP-FPM**: CMS funcionando con PHP 8.2
- **MariaDB**: Base de datos para WordPress
- **Vol칰menes persistentes**: Datos de WordPress y MariaDB
- **Red personalizada**: Comunicaci칩n entre contenedores
- **Secrets**: Gesti칩n segura de contrase침as

---

## Arquitectura del Proyecto: Microservicios

El proyecto sigue una arquitectura de tres capas donde cada servicio tiene una responsabilidad espec칤fica:

**Capa de Presentaci칩n (Nginx)**: Act칰a como proxy reverso y terminador TLS. Recibe todas las peticiones HTTPS del navegador, maneja los certificados SSL y redirige las peticiones de archivos PHP al contenedor de WordPress. Tambi칠n sirve archivos est치ticos directamente.

**Capa de Aplicaci칩n (WordPress)**: Ejecuta PHP-FPM que procesa el c칩digo de WordPress. No tiene conexi칩n directa con el exterior, solo recibe peticiones FastCGI desde Nginx. Se comunica con la base de datos para obtener y almacenar datos.

**Capa de Datos (MariaDB)**: Almacena toda la informaci칩n de WordPress: posts, usuarios, configuraciones, etc. Solo acepta conexiones desde el contenedor de WordPress, nunca del exterior.

**Red Docker (inception_net)**: Todos los contenedores est치n conectados a una red bridge personalizada que permite la comunicaci칩n interna usando nombres de host (nginx, wordpress, mariadb) en lugar de IPs.

**Vol칰menes Persistentes**: Los datos importantes (archivos de WordPress y base de datos) se almacenan en vol칰menes Docker que persisten incluso si los contenedores se destruyen.

---

## Flujo de Ejecuci칩n Completo

### Inicializaci칩n del Sistema

Cuando ejecutas `make build up`, Docker Compose orquesta el arranque de todos los servicios siguiendo un orden espec칤fico basado en las dependencias declaradas.

### Fase 1: Construcci칩n de Im치genes

Docker construye tres im치genes personalizadas basadas en Alpine Linux. Cada Dockerfile instala los paquetes necesarios, copia los archivos de configuraci칩n y scripts, y define el comando que se ejecutar치 cuando el contenedor arranque.

### Fase 2: Arranque de MariaDB

MariaDB es el primer servicio en arrancar porque WordPress depende de 칠l. El script de inicializaci칩n verifica si la base de datos ya existe. Si es la primera ejecuci칩n, instala MariaDB desde cero, crea la base de datos 'wordpress', y configura los usuarios con los permisos correctos.

Un aspecto cr칤tico es la configuraci칩n de red. MariaDB debe escuchar no solo en el socket Unix local, sino tambi칠n en el puerto TCP 3306 en todas las interfaces de red. Esto permite que WordPress, ejecut치ndose en otro contenedor, pueda conectarse.

El script crea m칰ltiples versiones del usuario `wp_user` para diferentes contextos de conexi칩n: localhost, el hostname espec칤fico que Docker asigna, y rangos de IP. Esto es necesario porque MySQL/MariaDB valida tanto el usuario como el host desde donde se conecta.

### Fase 3: Arranque de WordPress

Una vez que MariaDB est치 operativo (verificado por el healthcheck), WordPress puede arrancar. El script configura PHP-FPM para escuchar en todas las interfaces en el puerto 9000, no solo en localhost.

WordPress en s칤 viene preinstalado en la imagen, pero el archivo wp-config.php se genera din치micamente sustituyendo placeholders con los valores reales de la base de datos obtenidos desde los secrets.

Un detalle importante es que PHP-FPM debe configurarse espec칤ficamente para entornos Docker, cambiando la configuraci칩n de 'listen' para aceptar conexiones desde otros contenedores.

### Fase 4: Arranque de Nginx

Nginx es el 칰ltimo en arrancar. Primero genera un certificado TLS autofirmado usando OpenSSL con el dominio especificado. Luego valida su configuraci칩n antes de iniciar el servicio.

La configuraci칩n de Nginx incluye un bloque server que maneja HTTPS exclusivamente, con proxy reverso hacia WordPress para archivos PHP y servicio directo de archivos est치ticos.

### Flujo de una Petici칩n Web

Cuando un usuario navega a tu sitio, ocurre la siguiente secuencia:

1. **Resoluci칩n DNS**: El navegador resuelve el dominio (configurado en /etc/hosts para desarrollo local)
2. **Conexi칩n TLS**: Se establece el handshake SSL/TLS con Nginx
3. **Procesamiento Nginx**: Nginx eval칰a la petici칩n contra sus reglas de location
4. **Delegaci칩n FastCGI**: Para archivos PHP, Nginx env칤a la petici칩n a WordPress v칤a FastCGI
5. **Procesamiento PHP**: WordPress ejecuta el c칩digo PHP, que puede requerir consultas a la base de datos
6. **Consulta Database**: PHP se conecta a MariaDB usando las credenciales configuradas
7. **Respuesta**: La cadena se invierte, devolviendo el HTML generado al navegador

---

## Configuraci칩n Detallada por Servicio

### Nginx - Proxy Reverso y Terminaci칩n TLS

Nginx act칰a como el punto de entrada 칰nico al sistema. Su configuraci칩n principal incluye un bloque server que escucha exclusivamente en el puerto 443 con SSL habilitado. La directiva server_name especifica qu칠 dominios acepta.

Los certificados TLS se generan autom치ticamente al arrancar el contenedor. Aunque son autofirmados (no v치lidos para producci칩n), permiten cifrar el tr치fico y cumplir con los requisitos del proyecto.

La configuraci칩n de proxy reverso usa FastCGI para comunicarse con WordPress. Esto es m치s eficiente que HTTP porque FastCGI mantiene procesos PHP persistentes, evitando el overhead de crear/destruir procesos para cada petici칩n.

### WordPress - Gestor de Contenido y PHP-FPM

El contenedor WordPress ejecuta PHP-FPM en lugar del m칩dulo Apache tradicional. PHP-FPM es un gestor de procesos PHP que permite mejor control sobre recursos y rendimiento.

WordPress viene preinstalado, pero wp-config.php se genera din치micamente al arrancar el contenedor. Este archivo contiene configuraciones cr칤ticas como credenciales de base de datos, claves de seguridad y configuraciones espec칤ficas del entorno.

Las claves de seguridad (salt keys) se generan autom치ticamente y son 칰nicas para cada instalaci칩n. Estas claves se usan para cifrar cookies y sesiones, mejorando la seguridad.

### MariaDB - Base de Datos

MariaDB se configura con m칰ltiples archivos de configuraci칩n que se procesan en orden. El archivo principal (50-server.cnf) contiene configuraciones b치sicas, mientras que el archivo Docker-espec칤fico (99-docker.cnf) sobrescribe configuraciones para el entorno containerizado.

La configuraci칩n de usuarios es compleja porque MySQL/MariaDB valida tanto el nombre de usuario como el host de origen. Docker asigna hostnames espec칤ficos a los contenedores, por lo que es necesario crear el usuario para m칰ltiples patrones de host.

El charset se configura como utf8mb4 para soportar completamente Unicode, incluyendo emojis y caracteres especiales que WordPress puede usar.

---

## Redes y Vol칰menes

### Red Personalizada

Docker Compose crea autom치ticamente una red bridge personalizada llamada `wp_net`. Esta red proporciona aislamiento de otras aplicaciones Docker y permite que los contenedores se comuniquen usando nombres de host en lugar de IPs.

La red asigna autom치ticamente direcciones IP del rango 172.18.0.0/16, con el gateway en 172.18.0.1. Cada contenedor recibe una IP fija dentro de este rango, pero lo importante es que pueden referenciarse por nombre.

Docker incluye un servidor DNS interno que resuelve los nombres de los servicios (nginx, wordpress, mariadb) a sus IPs correspondientes. Esto hace que la configuraci칩n sea m치s robusta porque no depende de IPs espec칤ficas.

### Vol칰menes Persistentes

Los vol칰menes Docker permiten que los datos persistan independientemente del ciclo de vida de los contenedores. Se crean dos vol칰menes principales:

**wordpress_data**: Almacena todos los archivos de WordPress incluyendo el core, temas, plugins, uploads y wp-config.php. Esto asegura que cualquier personalizaci칩n o contenido subido no se pierda al reiniciar.

**mariadb_data**: Contiene todos los archivos de la base de datos incluyendo tablas, 칤ndices, logs de transacciones y configuraciones. Es cr칤tico para la persistencia de datos.

Los vol칰menes se almacenan f칤sicamente en el host Docker pero est치n gestionados completamente por Docker. Esto abstrae la gesti칩n del almacenamiento mientras proporciona persistencia.

---

## Gesti칩n de Secretos

Docker Compose incluye un sistema de secrets que permite gestionar informaci칩n sensible de forma segura. Los secrets se definen como archivos externos que se montan como archivos de solo lectura dentro de los contenedores.

Cada secret aparece como un archivo en /run/secrets/ dentro del contenedor. Los scripts pueden leer estos archivos para obtener contrase침as y configuraciones sensibles sin tenerlas hardcodeadas.

Este enfoque es m치s seguro que usar variables de entorno porque los secrets no aparecen en la lista de procesos, logs de Docker, o inspecci칩n de contenedores. Adem치s, tienen permisos restrictivos de solo lectura.

Los secrets se usan para las contrase침as de la base de datos (root y usuario), credenciales de WordPress (admin y usuario regular), y cualquier otra informaci칩n sensible necesaria para la aplicaci칩n.

---

## Comandos y Debugging

### Gesti칩n del Proyecto

El Makefile proporciona comandos simplificados para gestionar todo el stack. `make build` construye las im치genes, `make up` arranca los servicios, y `make fclean` realiza una limpieza completa incluyendo vol칰menes.

Para debugging, puedes acceder a los logs de cualquier servicio espec칤ficamente o ver logs de todos los servicios simult치neamente. Los logs muestran tanto la salida est치ndar como errores, facilitando la identificaci칩n de problemas.

### Testing de Conectividad

Puedes probar la conectividad entre contenedores usando herramientas como ping y netcat. Esto es 칰til para verificar que la red Docker funciona correctamente y que los servicios est치n escuchando en los puertos esperados.

Para verificar que los servicios est치n funcionando correctamente, puedes usar comandos espec칤ficos como conectarse directamente a MariaDB, verificar que PHP puede conectar a la base de datos, o comprobar que Nginx puede hacer proxy a WordPress.

### Inspecci칩n de Estado

Docker proporciona comandos para inspeccionar el estado de redes, vol칰menes y contenedores. Esto es invaluable para entender c칩mo Docker ha configurado la infraestructura y diagnosticar problemas de configuraci칩n.

---

## 游댢 Troubleshooting

### Problemas de Conectividad de Red

Los errores de "Connection refused" suelen indicar que un servicio no est치 escuchando en el puerto esperado o que hay problemas de configuraci칩n de red. El diagn칩stico t칤pico involucra verificar que los contenedores est치n en la misma red, que los puertos est치n abiertos, y que los servicios est치n configurados para escuchar en todas las interfaces.

### Problemas de Autenticaci칩n de Base de Datos

Los errores de "Access denied" en MySQL/MariaDB suelen deberse a problemas en la configuraci칩n de usuarios. MySQL valida tanto el usuario como el host, y Docker puede usar hostnames espec칤ficos que no coinciden con la configuraci칩n inicial del usuario.

La soluci칩n t칤pica involucra crear el usuario para m칰ltiples patrones de host o identificar exactamente desde qu칠 hostname se est치 conectando WordPress.

### Problemas de Proxy y FastCGI

Cuando Nginx no puede conectar con WordPress, suele ser porque PHP-FPM no est치 configurado correctamente para aceptar conexiones de otros contenedores, o porque la configuraci칩n FastCGI de Nginx tiene errores.

### Problemas de Certificados

Los navegadores modernos son estrictos con los certificados SSL. Los certificados autofirmados requieren excepciones manuales o configuraci칩n espec칤fica del navegador para ser aceptados.

### Problemas de Persistencia

Si los datos no persisten entre reinicios, puede ser que los vol칰menes no est칠n configurados correctamente, que los paths de montaje sean incorrectos, o que haya problemas de permisos dentro de los contenedores.

---

## Conceptos Clave del Proyecto

### 쯇or qu칠 esta Arquitectura?

La separaci칩n de servicios en contenedores individuales sigue principios de microservicios: cada contenedor tiene una responsabilidad espec칤fica, pueden escalarse independientemente, y los fallos est치n aislados.

### Seguridad por Dise침o

El uso de una red personalizada a칤sla los servicios del exterior. Solo Nginx expone puertos p칰blicos, mientras que WordPress y MariaDB son inaccesibles directamente desde fuera del stack.

### Persistencia vs Inmutabilidad

Los contenedores son inmutables (se destruyen y recrean), pero los datos importantes persisten en vol칰menes. Esto permite actualizaciones limpias mientras se mantiene la informaci칩n cr칤tica.

### Configuraci칩n Din치mica

Los scripts de inicializaci칩n permiten que la misma imagen Docker funcione en diferentes entornos simplemente cambiando variables de entorno y secrets, sin necesidad de reconstruir im치genes.

